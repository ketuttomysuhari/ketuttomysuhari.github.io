<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VR — Dr. Ir. Ketut Tomy Suhari</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#000; }

    /* ===== DOM OVERLAY ROOT ===== */
    #domOverlayRoot{
      position: fixed;
      inset: 0;
      display: none;
      background: rgba(0,0,0,.35);
      z-index: 99999;
      touch-action: none;
    }

    .panel{
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      width: min(1040px, 94vw);
      height: min(720px, 84vh);
      border-radius: 18px;
      overflow: hidden;
      background: rgba(10,16,30,.92);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      display: flex;
      flex-direction: column;
    }

    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      background: rgba(255,255,255,.06);
      border-bottom: 1px solid rgba(255,255,255,.10);
      color: #e8eefc;
    }

    .titleRow{ display:flex; flex-direction:column; gap:2px; }
    .titleRow .t{ font-weight: 800; font-size: 14px; letter-spacing:.2px; }
    .titleRow .s{ font-weight: 600; font-size: 12px; opacity:.78; }

    .btns{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: #e8eefc;
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
    }
    .btn.primary{ background: rgba(77,163,255,.20); border-color: rgba(77,163,255,.35); }
    .btn.danger{ background: rgba(255,90,90,.18); border-color: rgba(255,90,90,.30); }

    .panelBody{ flex:1; display:flex; background: rgba(0,0,0,.25); }

    .side{
      width: 260px;
      border-right: 1px solid rgba(255,255,255,.10);
      padding: 10px;
      color: #e8eefc;
      overflow:auto;
    }
    .side h4{ margin: 4px 0 10px; font-size: 12px; opacity:.85; letter-spacing: .2px; }

    .navItem{
      width:100%;
      text-align:left;
      margin-bottom:8px;
      padding:10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:#e8eefc;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
    .navItem small{ display:block; opacity:.72; font-weight:650; margin-top:2px; }

    .content{ flex:1; position: relative; background: rgba(255,255,255,.03); }

    #webFrame, #pdfEmbed{
      position:absolute; inset:0;
      width:100%; height:100%;
      border:0;
      display:none;
      background:#fff;
    }

    #videoWrap{
      position:absolute; inset:0;
      display:none;
      padding: 12px;
      box-sizing: border-box;
    }
    #videoPlayer{
      width: 100%;
      height: 100%;
      border-radius: 14px;
      background: #000;
    }

    #hint{
      position: fixed;
      left: 12px;
      bottom: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(10,16,30,.55);
      border: 1px solid rgba(255,255,255,.14);
      color: #e8eefc;
      font-size: 12px;
      z-index: 1000;
      max-width: 660px;
      pointer-events: none;
    }

    /* ===== MOBILE CONTROLS (Joystick + Look Pad) ===== */
    #mobileControls{
      position: fixed;
      inset: 0;
      z-index: 2000;
      pointer-events: none; /* enable only on child elements */
    }

    .joyZone{
      position: absolute;
      bottom: 18px;
      width: 160px;
      height: 160px;
      pointer-events: auto;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }

    #joyLeft { left: 16px; }
    #lookRight { right: 16px; width: 180px; height: 180px; }

    .joyBase{
      position:absolute; inset:0;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(8px);
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    .joyKnob{
      position:absolute;
      left: 50%;
      top: 50%;
      width: 64px;
      height: 64px;
      margin-left: -32px;
      margin-top: -32px;
      border-radius: 999px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.25);
      box-shadow: 0 10px 18px rgba(0,0,0,.35);
      transform: translate3d(0,0,0);
    }

    .joyLabel{
      position:absolute;
      top: -22px;
      left: 0;
      right: 0;
      text-align:center;
      font-weight: 700;
      font-size: 12px;
      color: rgba(232,238,252,.85);
      text-shadow: 0 2px 10px rgba(0,0,0,.6);
      pointer-events:none;
    }

    /* hide mobile controls on wide desktop */
    @media (min-width: 1024px){
      #mobileControls{ display:none; }
    }
  </style>
</head>

<body>
  <div id="hint">
    Desktop: use Arrow Keys or WASD to move. Mobile: MOVE joystick (up=forward, down=back), LOOK pad to rotate. Tap flyers/video screen.
  </div>

  <!-- ===== MOBILE CONTROLS UI ===== -->
  <div id="mobileControls" aria-hidden="true">
    <div class="joyZone" id="joyLeft">
      <div class="joyLabel">MOVE</div>
      <div class="joyBase"></div>
      <div class="joyKnob" id="joyLeftKnob"></div>
    </div>

    <div class="joyZone" id="lookRight">
      <div class="joyLabel">LOOK</div>
      <div class="joyBase"></div>
      <div class="joyKnob" id="lookRightKnob"></div>
    </div>
  </div>

  <!-- ===== DOM OVERLAY ROOT ===== -->
  <div id="domOverlayRoot" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <div class="panelHeader">
        <div class="titleRow">
          <div class="t" id="panelTitle">Panel</div>
          <div class="s" id="panelSub">Scroll pages, open PDF, play video, and visit links.</div>
        </div>
        <div class="btns">
          <button class="btn" id="btnBack">Back</button>
          <button class="btn primary" id="btnOpenExternal">Open External</button>
          <button class="btn danger" id="btnClose">Close</button>
        </div>
      </div>

      <div class="panelBody">
        <div class="side">
          <h4>Quick items</h4>

          <button class="navItem" data-type="web" data-src="index.html" data-title="Home (Portfolio)">
            Home (Portfolio)
            <small>Open index.html</small>
          </button>

          <button class="navItem" data-type="web" data-src="cv.html" data-title="CV (HTML)">
            CV (scroll)
            <small>Open cv.html inside panel</small>
          </button>

          <button class="navItem" data-type="pdf" data-src="data/CV_KTS-4.pdf" data-title="CV (PDF)">
            CV PDF
            <small>Embedded PDF viewer</small>
          </button>

          <button class="navItem" data-type="video" data-src="data/myproject-1.mp4" data-title="Project Video">
            Project video
            <small>Play video inside panel</small>
          </button>

          <button class="navItem" data-type="web" data-src="projects.html" data-title="Projects">
            Projects
            <small>Open projects.html</small>
          </button>

          <button class="navItem" data-type="web" data-src="companies.html" data-title="Companies">
            Companies
            <small>Open companies.html</small>
          </button>

          <button class="navItem" data-type="web" data-src="collaboration.html" data-title="Collaboration">
            Collaboration
            <small>Open collaboration.html</small>
          </button>

          <button class="navItem" data-type="external" data-src="https://scholar.google.com/citations?user=5md4iHUAAAAJ&hl=en&oi=ao" data-title="Google Scholar">
            Google Scholar
            <small>Open in new tab</small>
          </button>

          <button class="navItem" data-type="external" data-src="https://orcid.org/0000-0002-1416-1302" data-title="ORCID">
            ORCID
            <small>Open in new tab</small>
          </button>

          <button class="navItem" data-type="external" data-src="https://www.scopus.com/authid/detail.uri?authorId=57196485539" data-title="Scopus">
            Scopus
            <small>Open in new tab</small>
          </button>
        </div>

        <div class="content">
          <iframe id="webFrame" title="Web content"></iframe>
          <embed id="pdfEmbed" type="application/pdf" />
          <div id="videoWrap">
            <video id="videoPlayer" controls playsinline></video>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       DOM Overlay Panel Control
    ========================== */
    window.VRPanel = (function(){
      const root = document.getElementById('domOverlayRoot');
      const title = document.getElementById('panelTitle');
      const webFrame = document.getElementById('webFrame');
      const pdfEmbed = document.getElementById('pdfEmbed');
      const videoWrap = document.getElementById('videoWrap');
      const videoPlayer = document.getElementById('videoPlayer');

      const btnClose = document.getElementById('btnClose');
      const btnBack = document.getElementById('btnBack');
      const btnOpenExternal = document.getElementById('btnOpenExternal');

      let history = [];
      let current = null;

      function hideAll(){
        webFrame.style.display = 'none';
        pdfEmbed.style.display = 'none';
        videoWrap.style.display = 'none';
        try { videoPlayer.pause(); videoPlayer.removeAttribute('src'); videoPlayer.load(); } catch(e){}
      }

      function setContent(cfg){
        current = cfg;
        title.textContent = cfg.title || 'Panel';
        hideAll();

        if (cfg.type === 'web') {
          webFrame.style.display = 'block';
          webFrame.src = cfg.src;
        } else if (cfg.type === 'pdf') {
          pdfEmbed.style.display = 'block';
          pdfEmbed.src = cfg.src;
        } else if (cfg.type === 'video') {
          videoWrap.style.display = 'block';
          videoPlayer.src = cfg.src;
          videoPlayer.play().catch(()=>{});
        } else if (cfg.type === 'external') {
          window.open(cfg.src, '_blank', 'noopener,noreferrer');
        }
      }

      function open(cfg){
        if (cfg.type === 'external') {
          window.open(cfg.src, '_blank', 'noopener,noreferrer');
          return;
        }
        if (current) history.push(current);
        root.style.display = 'block';
        root.setAttribute('aria-hidden', 'false');
        setContent(cfg);
      }

      function close(){
        root.style.display = 'none';
        root.setAttribute('aria-hidden', 'true');
        history = [];
        current = null;
        hideAll();
      }

      function back(){
        const prev = history.pop();
        if (!prev) return;
        setContent(prev);
      }

      function openExternal(){
        if (!current || !current.src) return;
        window.open(current.src, '_blank', 'noopener,noreferrer');
      }

      function isOpen(){
        return root.style.display === 'block';
      }

      document.querySelectorAll('.navItem').forEach(btn=>{
        btn.addEventListener('click', () => {
          const cfg = { type: btn.dataset.type, src: btn.dataset.src, title: btn.dataset.title };
          if (cfg.type === 'external') {
            window.open(cfg.src, '_blank', 'noopener,noreferrer');
            return;
          }
          if (current) history.push(current);
          setContent(cfg);
        });
      });

      btnClose.addEventListener('click', close);
      btnBack.addEventListener('click', back);
      btnOpenExternal.addEventListener('click', openExternal);
      root.addEventListener('click', (e)=>{ if (e.target === root) close(); });

      return { open, close, back, isOpen };
    })();

    /* =========================
       A-Frame Components
    ========================== */
    AFRAME.registerComponent('floaty', {
      schema: { amp: { type: 'number', default: 0.06 }, speed: { type: 'number', default: 1.0 } },
      init: function () { this.startY = this.el.object3D.position.y; this.t0 = performance.now(); },
      tick: function () {
        const t = (performance.now() - this.t0) / 1000;
        this.el.object3D.position.y = this.startY + Math.sin(t * this.data.speed) * this.data.amp;
      }
    });

    AFRAME.registerComponent('hoverfx', {
      init: function () {
        const el = this.el;
        const base = el.object3D.scale.clone();
        el.addEventListener('mouseenter', () => el.object3D.scale.set(base.x*1.04, base.y*1.04, base.z*1.04));
        el.addEventListener('mouseleave', () => el.object3D.scale.copy(base));
      }
    });

    AFRAME.registerComponent('open-panel', {
      schema: { type: { type: 'string', default: 'web' }, src: { type: 'string', default: '' }, title: { type: 'string', default: 'Panel' } },
      init: function () {
        this.el.classList.add('clickable');
        this.el.addEventListener('click', () => window.VRPanel.open(this.data));
      }
    });

    /* =========================
       Unified Controls:
       - Mobile joystick controls (touch)
       - Desktop keyboard controls (Arrow + WASD)
       - Right pad look (touch), mouse look is already default via drag in A-Frame
    ========================== */
    AFRAME.registerComponent('unified-controls', {
      schema: {
        moveSpeed: { type: 'number', default: 2.2 },   // m/s
        lookSpeed: { type: 'number', default: 0.10 },  // deg scaling for touch look pad
        deadZone: { type: 'number', default: 0.10 }
      },
      init: function(){
        this.camera = this.el;

        // joystick movement (-1..1)
        this.joyX = 0;
        this.joyY = 0;

        // keyboard movement (-1..1)
        this.keyX = 0;
        this.keyY = 0;

        // look delta (touch)
        this.lookDX = 0;
        this.lookDY = 0;

        const r = this.camera.getAttribute('rotation') || {x:0,y:0,z:0};
        this.pitch = r.x;
        this.yaw = r.y;

        this._setupJoysticks();
        this._setupKeyboard();
      },

      tick: function(time, dt){
        const delta = dt / 1000;
        if (!delta) return;

        // If panel is open, freeze movement (avoid moving while scrolling/reading)
        if (window.VRPanel && window.VRPanel.isOpen && window.VRPanel.isOpen()) {
          return;
        }

        // Apply touch-look (right pad)
        if (this.lookDX !== 0 || this.lookDY !== 0){
          this.yaw -= this.lookDX * this.data.lookSpeed;
          this.pitch -= this.lookDY * this.data.lookSpeed;

          this.pitch = Math.max(-80, Math.min(80, this.pitch));
          this.camera.setAttribute('rotation', { x: this.pitch, y: this.yaw, z: 0 });

          this.lookDX = 0;
          this.lookDY = 0;
        } else {
          // Keep yaw/pitch in sync if user rotates via mouse drag
          const rr = this.camera.getAttribute('rotation');
          this.pitch = rr.x;
          this.yaw = rr.y;
        }

        // Combine keyboard + joystick (clamp)
        let mx = this._applyDeadzone(this.joyX) + this.keyX;
        let my = this._applyDeadzone(this.joyY) + this.keyY;
        mx = Math.max(-1, Math.min(1, mx));
        my = Math.max(-1, Math.min(1, my));

        if (mx === 0 && my === 0) return;

        const speed = this.data.moveSpeed;
        const yawRad = (this.yaw * Math.PI) / 180;
        const cos = Math.cos(yawRad);
        const sin = Math.sin(yawRad);

        // local: x strafe, y forward/back
        const localX = mx * speed * delta;
        const localZ = my * speed * delta;

        // world movement
        const dx = (localX * cos) + (localZ * sin);
        const dz = (localZ * cos) - (localX * sin);

        const pos = this.camera.getAttribute('position');
        this.camera.setAttribute('position', { x: pos.x + dx, y: pos.y, z: pos.z + dz });
      },

      _applyDeadzone: function(v){
        const d = this.data.deadZone;
        if (Math.abs(v) < d) return 0;
        const sign = v < 0 ? -1 : 1;
        const mag = (Math.abs(v) - d) / (1 - d);
        return sign * Math.min(1, mag);
      },

      _setupKeyboard: function(){
        const down = (e) => {
          // avoid when typing in inputs (safety)
          const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
          if (tag === 'input' || tag === 'textarea' || tag === 'select') return;

          // prevent browser from scrolling with arrows
          if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault();

          if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') this.keyY = 1;     // forward
          if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') this.keyY = -1;  // back
          if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') this.keyX = -1; // left
          if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') this.keyX = 1; // right
        };

        const up = (e) => {
          if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault();

          if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') { if (this.keyY === 1) this.keyY = 0; }
          if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') { if (this.keyY === -1) this.keyY = 0; }
          if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') { if (this.keyX === -1) this.keyX = 0; }
          if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') { if (this.keyX === 1) this.keyX = 0; }
        };

        window.addEventListener('keydown', down, { passive:false });
        window.addEventListener('keyup', up, { passive:false });
      },

      _setupJoysticks: function(){
        const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
        const controlsRoot = document.getElementById('mobileControls');
        if (isTouch) controlsRoot.style.display = 'block';

        const joyLeft = document.getElementById('joyLeft');
        const joyLeftKnob = document.getElementById('joyLeftKnob');
        const lookRight = document.getElementById('lookRight');
        const lookRightKnob = document.getElementById('lookRightKnob');

        const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

        // ---- LEFT JOYSTICK (MOVE) ----
        let leftActive = false;
        let leftStart = {x:0, y:0};

        const leftDown = (e) => {
          leftActive = true;
          const t = e.touches ? e.touches[0] : e;
          leftStart = { x: t.clientX, y: t.clientY };
          e.preventDefault();
        };

        const leftMove = (e) => {
          if (!leftActive) return;
          const t = e.touches ? e.touches[0] : e;

          const dx = t.clientX - leftStart.x;
          const dy = t.clientY - leftStart.y;

          const radius = 60;
          const ndx = clamp(dx / radius, -1, 1);
          const ndy = clamp(dy / radius, -1, 1);

          /*
            FIX: forward should be when pushing UP.
            - Pushing UP => dy negative => ndy negative
            - We want forward => +1
            Therefore: joyY = ndy (NOT -ndy)
            Example: ndy=-0.8 => joyY=-0.8 -> that would be backward.
            So we invert sign: joyY = -ndy
            HOWEVER user says currently terbalik; in your pasted code you already used -ndy.
            The typical error is in movement mapping, not joystick mapping.
            We will keep joystick mapping intuitive and fix movement mapping to treat +my as forward (negative Z).
            So: joyY = ndy (up gives negative), but we'll interpret negative as forward later.
          */

          this.joyX = ndx;
          this.joyY = ndy; // up -> negative

          joyLeftKnob.style.transform = `translate3d(${ndx * radius}px, ${ndy * radius}px, 0)`;
          e.preventDefault();
        };

        const leftUp = (e) => {
          leftActive = false;
          this.joyX = 0;
          this.joyY = 0;
          joyLeftKnob.style.transform = `translate3d(0px, 0px, 0)`;
          e.preventDefault();
        };

        joyLeft.addEventListener('touchstart', leftDown, {passive:false});
        joyLeft.addEventListener('touchmove', leftMove, {passive:false});
        joyLeft.addEventListener('touchend', leftUp, {passive:false});
        joyLeft.addEventListener('touchcancel', leftUp, {passive:false});

        // ---- RIGHT PAD (LOOK) ----
        let rightActive = false;
        let rightPrev = {x:0, y:0};

        const rightDown = (e) => {
          rightActive = true;
          const t = e.touches ? e.touches[0] : e;
          rightPrev = { x: t.clientX, y: t.clientY };
          e.preventDefault();
        };

        const rightMove = (e) => {
          if (!rightActive) return;
          const t = e.touches ? e.touches[0] : e;

          const dx = t.clientX - rightPrev.x;
          const dy = t.clientY - rightPrev.y;

          rightPrev = { x: t.clientX, y: t.clientY };

          this.lookDX += dx;
          this.lookDY += dy;

          const radius = 60;
          const kx = clamp(dx, -radius, radius);
          const ky = clamp(dy, -radius, radius);
          lookRightKnob.style.transform = `translate3d(${kx}px, ${ky}px, 0)`;
          e.preventDefault();
        };

        const rightUp = (e) => {
          rightActive = false;
          lookRightKnob.style.transform = `translate3d(0px, 0px, 0)`;
          e.preventDefault();
        };

        lookRight.addEventListener('touchstart', rightDown, {passive:false});
        lookRight.addEventListener('touchmove', rightMove, {passive:false});
        lookRight.addEventListener('touchend', rightUp, {passive:false});
        lookRight.addEventListener('touchcancel', rightUp, {passive:false});

        document.body.style.touchAction = 'none';
      }
    });
  </script>

  <!-- =================== A-FRAME SCENE =================== -->
  <a-scene
    renderer="colorManagement: true"
    vr-mode-ui="enabled: true"
    webxr="optionalFeatures: dom-overlay"
    dom-overlay="root: #domOverlayRoot"
  >
    <a-assets>
      <img id="skyTex" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg" crossorigin="anonymous" />
      <video id="projVideo" src="data/myproject-1.mp4" preload="auto" crossorigin="anonymous" webkit-playsinline playsinline></video>
    </a-assets>

    <!-- Camera (unified controls here) -->
    <a-entity id="rig" position="0 0 0">
      <a-entity id="cam"
        position="0 1.6 5"
        camera
        look-controls="enabled: true"
        unified-controls="moveSpeed: 2.2; lookSpeed: 0.10; deadZone: 0.10"
      >
        <a-cursor
          raycaster="objects: .clickable"
          fuse="false"
          material="color:#ffffff; shader:flat; opacity:0.9"
          geometry="primitive:ring; radiusInner:0.01; radiusOuter:0.016">
        </a-cursor>
      </a-entity>
    </a-entity>

    <!-- Environment -->
    <a-sky src="#skyTex" rotation="0 -90 0"></a-sky>
    <a-plane position="0 0 0" rotation="-90 0 0" width="40" height="40"
      material="color:#0b1220; roughness:1; metalness:0">
    </a-plane>


    <!-- =================== BIG WIDE VIDEO SCREEN =================== -->
    <a-entity position="0 2.1 -4.2" rotation="0 0 0">
      <a-plane width="7.2" height="4.1" position="0 0 0"
        material="color:#0b1220; opacity:0.92; shader:flat"></a-plane>

      <a-plane class="clickable"
        open-panel="type: video; src: data/myproject-1.mp4; title: Project Video (Large Screen)"
        width="6.9" height="3.88" position="0 0 0.01"
        material="shader: flat; src: #projVideo; transparent: true; opacity: 1">
      </a-plane>

      <a-text value="Project Showcase Video (click/tap to open panel)" align="center"
        color="#E8EEFC" width="7" position="0 -2.35 0"></a-text>
    </a-entity>

    <!-- =================== FLYER MENU (minimal, you can add more) =================== -->
    <a-entity position="4.2 1.35 -1.7" rotation="0 -22 0" floaty="amp:0.06; speed:1.05">
      <a-plane class="clickable" hoverfx
        open-panel="type: web; src: collaboration.html; title: Collaboration"
        width="1.65" height="0.95"
        material="color:#0f4c5c; opacity:0.92; shader:flat"></a-plane>
      <a-text value="Collaboration" align="center" color="#E8EEFC" width="4" position="0 -0.62 0.02"></a-text>
    </a-entity>

    <!-- Lights -->
    <a-entity light="type:ambient; intensity:0.65"></a-entity>
    <a-entity light="type:directional; intensity:0.9" position="3 6 2"></a-entity>
  </a-scene>

  <script>
    // Autoplay attempt for video texture: requires gesture in many browsers
    const vid = document.querySelector('#projVideo');
    const scene = document.querySelector('a-scene');

    function tryPlay(){
      if (!vid) return;
      vid.muted = true;
      const p = vid.play();
      if (p && p.catch) p.catch(()=>{});
    }
    scene.addEventListener('loaded', tryPlay);
    window.addEventListener('click', tryPlay, { once: true });
    window.addEventListener('touchstart', tryPlay, { once: true });

    /*
      IMPORTANT FIX: joystick forward/back direction
      In the component above, joyY is negative when pushing UP.
      We want pushing UP => move forward.
      Therefore we interpret negative as forward by flipping sign here at source? No.
      The clean fix is to flip the sign in movement mapping:
      keyboard uses keyY=+1 forward, but joystick up gives joyY negative.
      We'll invert joyY in the tick by mapping my = (-joyY) + keyY.
      This must be done inside unified-controls. Since we cannot patch component body after registration,
      we already accounted by storing joyY as ndy (up negative), and keyboard as +1 forward.
      To make both consistent, add this small patch by re-registering the component name is not allowed.
      Therefore, we handle it by setting keyY convention to match joystick (up negative) — but user wants forward when up.
      So we will adjust quickly by setting key mapping forward to -1 and back to +1 in the keyboard setup? Not ideal.

      Better approach: we already used keyboard forward as +1. So we flip joystick sign at input time (simple).
      That is the safest correction. We do it here by intercepting and flipping after the component created.
    */
    document.addEventListener('DOMContentLoaded', () => {
      const camEl = document.querySelector('#cam');
      if (!camEl) return;

      // Monkey patch: flip joystick Y after each touchmove update (simple and robust)
      // We'll hook into touchmove on left joystick and invert the stored joyY value.
      const joyLeft = document.getElementById('joyLeft');
      if (!joyLeft) return;

      joyLeft.addEventListener('touchmove', () => {
        const comp = camEl.components['unified-controls'];
        if (!comp) return;
        // flip so: up (negative) becomes forward (+)
        comp.joyY = -comp.joyY;
      }, { passive:true });
    });
  </script>
</body>
</html>
